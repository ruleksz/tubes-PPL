name: laravel-tests

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, pcntl, pdo_mysql
          coverage: xdebug

      - name: Install Dependencies
        run: composer install --no-progress --prefer-dist

      - name: Copy .env.example to .env
        run: cp .env.example .env

      - name: Generate App Key
        run: php artisan key:generate

      - name: Laravel Validator
        run: |
          echo "ğŸ” Running Laravel project validator..."

          REQUIRED_DIRS=("app" "routes" "vendor")
          for DIR in "${REQUIRED_DIRS[@]}"; do
            if [ ! -d "$DIR" ]; then
              echo "âŒ ERROR: Folder wajib tidak ditemukan â†’ $DIR"
              exit 1
            fi
          done

          echo "âœ” Folder Laravel lengkap."

          # Validate composer.json exists and valid
          if [ ! -f composer.json ]; then
            echo "âŒ ERROR: composer.json tidak ditemukan!"
            exit 1
          fi

          echo "âœ” composer.json ditemukan. Validating JSON..."
          cat composer.json | jq empty || (echo "âŒ composer.json tidak valid JSON!" && exit 1)

          # Validate .env.example
          if [ ! -f .env.example ]; then
            echo "âŒ ERROR: .env.example wajib ada!"
            exit 1
          fi

          echo "âœ” env.example ditemukan."

          # PHP linting
          echo "ğŸ” Checking PHP syntax..."
          PHP_FILES=$(git ls-files "*.php")
          for FILE in $PHP_FILES; do
            php -l "$FILE" >/dev/null 2>&1 || (echo "âŒ Syntax error di file: $FILE" && exit 1)
          done

          echo "âœ” Tidak ada syntax PHP error."

          # Check for empty PHP files
          for FILE in $PHP_FILES; do
            if [ ! -s "$FILE" ]; then
              echo "âŒ File PHP kosong ditemukan: $FILE"
              exit 1
            fi
          done

          echo "âœ” Semua file PHP memiliki isi."
          echo "ğŸ‰ Laravel validator PASSED!"

      - name: Gagal Jika bukan File PHP ke inti Laravel
        run: |
          # Skip jika tidak ada commit sebelumnya
          if ! git rev-parse HEAD~1 >/dev/null 2>&1; then
            echo "âš  First commit detected â€” skip core file validation."
            exit 0
          fi

          PREV=HEAD~1
          INVALID=$(git diff --name-only $PREV HEAD | grep -E "^(curhat-app/app|curhat-app/routes)/.*\.(txt|json|js|md|css|env)$" || true)

          if [ -n "$INVALID" ]; then
            echo "âŒ File tidak valid ditambahkan ke folder inti Laravel:"
            echo "$INVALID"
            exit 1
          fi

          echo "âœ” Tidak ada file asing."

      - name: Gagal jika collaborator menambahkan folder asing
        run: |
          if ! git rev-parse HEAD~1 >/dev/null 2>&1; then
            echo "âš  First commit detected â€” skip folder validation."
            exit 0
          fi

          PREV=HEAD~1
          NEW_DIRS=$(git diff --dirstat=files,0 $PREV HEAD | awk '{print $2}')
          APP_DIRS=$(echo "$NEW_DIRS" | grep "^curhat-app/" || true)

          WHITELIST="^curhat-app/(app|bootstrap|config|database|lang|public|resources|routes|storage|tests|vendor)/"

          INVALID=$(echo "$APP_DIRS" | grep -vE "$WHITELIST" || true)

          if [ -n "$INVALID" ]; then
            echo "âŒ Folder baru tidak dikenal terdeteksi:"
            echo "$INVALID"
            exit 1
          fi

          echo "âœ” Tidak ada folder baru berbahaya."

      - name: Gagal jika kebanyakan Debugg (dd, dump, var_dump)
        run: |
          if ! git rev-parse HEAD~1 >/dev/null 2>&1; then
            echo "âš  First commit detected â€” skip debug check."
            exit 0
          fi

          PREV=HEAD~1
          CHANGED_FILES=$(git diff --name-only $PREV HEAD | grep "\.php$" || true)

          for FILE in $CHANGED_FILES; do
            if grep -E "dd\(|dump\(|var_dump\(" "$FILE" > /dev/null; then
              echo "âŒ Dilarang push kode berisi dd(), dump(), var_dump() â†’ $FILE"
              exit 1
            fi
          done

          echo "âœ” Tidak ada debug code."

      - name: Run Tests
        run: php artisan test
